{% extends "base.html" %}
{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  [x-cloak] { display: none !important; }
  :root{
    --ink:#0f172a;            /* deep slate */
    --ink-2:#1f2937;
    --muted:#6b7280;
    --line:#e5e7eb;
    --bg:#f8fafc;
    --card:#ffffff;
    --teal:#0ea5a6;           /* accent */
    --teal-2:#14b8a6;
    --rose:#ef4444;
    --amber:#f59e0b;
    --success:#22c55e;
  }
  body{ background: var(--bg); }
  .page-wrap{ padding-top: 10px; }
  .page-title{
    font-weight: 800; letter-spacing: .2px; color: var(--ink);
  }
  .subtext{ color: var(--muted); }
  .filter-card{
    background: var(--card); border:1px solid var(--line); border-radius: 16px; padding: 16px;
  }
  .btn-ghost{
    border: 1px solid var(--line); background:#fff; color:var(--ink); border-radius: 12px;
  }
  .btn-ghost:hover{ background:#f3f4f6; }
  .btn-teal{
    background: var(--teal); color: #fff; border:none; border-radius:12px; box-shadow: 0 4px 12px rgba(14,165,166,.2);
  }
  .btn-teal:hover{ background: var(--teal-2); color:#fff; }
  .chip{
    border:1px dashed #d1d5db; padding:2px 8px; border-radius:999px; font-size:.8rem; color:var(--ink-2);
    white-space: normal; /* allow wrap on mobile */
  }
  .qty-pill{
    font-variant-numeric: tabular-nums;
    background: rgba(20,184,166,.12); color: var(--teal-2);
    border:1px solid rgba(20,184,166,.25);
    padding: 6px 12px; border-radius: 999px; font-weight: 800;
  }
  .row-card{
    border:1px solid var(--line); border-radius: 16px; background: var(--card);
    padding: 14px 16px; transition: transform .12s ease, box-shadow .12s ease;
    overflow: hidden; /* prevent horizontal scroll */
  }
  .row-card:hover{ transform: translateY(-1px); box-shadow: 0 8px 24px rgba(2,6,23,.06); }
  .row-divider{ height: 1px; background: var(--line); margin: 10px 0; }
  .qty-group .btn{ width: 36px; }
  .qty-display{
    min-width: 42px; text-align:center; border:1px solid var(--line); border-radius: 10px; padding: 4px 8px;
    font-variant-numeric: tabular-nums; font-weight: 600; background:#fff;
  }
  .toolbar{
    position: sticky; top: 8px; z-index: 10;
    background: transparent;
  }
  /* Simple toast */
  #toast{
    position: fixed; right: 16px; bottom: 16px; z-index: 1080;
    display: none; max-width: 320px;
  }
  .toast-card{
    background:#111827; color:#fff; border-radius: 12px; padding: 10px 14px; box-shadow: 0 12px 28px rgba(2,6,23,.35);
  }
  .badge-light{
    background: #f3f4f6; color: #111827; border:1px solid #e5e7eb;
    white-space: normal; display: inline-block; margin-top: 4px; /* allow wrap */
  }
  .help-kb{
    font-size: .85rem; color: var(--muted);
  }

  /* Let flex children shrink to avoid overflow on small screens */
  .row-card * { min-width: 0; }

  /* Mobile layout for the action cluster */
  @media (max-width: 576px) {
    .row-card { padding: 12px; }
    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      width: 100%;
    }
    .actions .qty-pill { order: 1; justify-self: start; }
    .actions .btn-group { order: 3; justify-self: start; }
    .actions .btn-success { order: 2; width: 100%; justify-self: end; }
    .actions .dropdown { order: 4; justify-self: end; }
  }
</style>

<div class="container page-wrap">
  <!-- Header / Actions -->
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
    <h2 class="page-title mb-2 mb-md-0">üõí Shopping ¬∑ View</h2>
    <div class="d-flex gap-2">
      <a href="/admin/dashboard" class="btn btn-ghost">üè† Home</a>
      <a href="/admin/shopping/items" class="btn btn-ghost">Create Shopping Cart</a>
    </div>
  </div>

  <!-- Filters (sticky) -->
  <div class="toolbar">
    <form class="filter-card mb-3" method="get">
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-4">
          <label class="form-label">Supplier</label>
          <select class="form-select" name="supplier_id">
            <option value="">All suppliers</option>
            {% for s in suppliers %}
              <option value="{{ s.id }}" {% if active_supplier_id and s.id==active_supplier_id %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Business Line</label>
          <select class="form-select" name="business_line_id">
            <option value="">All lines</option>
            {% for b in business_lines %}
              <option value="{{ b.id }}" {% if active_business_line_id and b.id==active_business_line_id %}selected{% endif %}>{{ b.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Search</label>
          <div class="input-group">
            <input class="form-control" name="q" value="{{ q or '' }}" placeholder="Name, SKU, notes...">
            <button class="btn btn-teal" type="submit">Filter</button>
            {% if q or active_supplier_id or active_business_line_id %}
              <a class="btn btn-ghost" href="/admin/shopping/view">Clear</a>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="mt-2 help-kb">
        Pro tip: Use <kbd>+</kbd> and <kbd>‚Äì</kbd> to adjust quantity on the focused row ‚Ä¢ Press <kbd>P</kbd> to mark Purchased
      </div>
    </form>
  </div>

  <!-- Empty state -->
  {% if not needs %}
    <div class="text-center subtext py-5">
      <div class="mb-2">Nothing needed yet with the current filters.</div>
      <a class="btn btn-ghost" href="/admin/shopping/view">Show all</a>
    </div>
  {% else %}

    <!-- List -->
    <div class="d-flex flex-column gap-2">
      {% for need in needs %}
      <div class="row-card"
           tabindex="0"
           x-data="rowState('{{ need.item_id }}', {{ need.quantity }})"
           @keydown.stop.prevent.plus="inc()"
           @keydown.stop.prevent.equal="inc()"   <!-- some keyboards map '+' to '=' without shift -->
           @keydown.stop.prevent.-="dec()"
           @keydown.stop.prevent.p="mark('PURCHASED')">

        <!-- Top row -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2">
          <!-- Left info: allow shrinking -->
          <div class="me-md-2 flex-fill">
            <div class="d-flex align-items-center flex-wrap gap-2">
              <h5 class="mb-0" style="font-weight:800;color:var(--ink);">
                {{ need.item.name }}
              </h5>
              {% if need.item.sku %}
                <span class="chip">SKU: {{ need.item.sku }}</span>
              {% endif %}
              {% if need.item.unit %}
                <span class="chip">{{ need.item.unit }}</span>
              {% endif %}
            </div>

            <div class="mt-1 subtext">
              {% if need.supplier %}
                <span class="badge badge-light rounded-pill me-1">Supplier: {{ need.supplier.name }}</span>
              {% endif %}
              {% if need.item.business_line %}
                <span class="badge badge-light rounded-pill me-1">Line: {{ need.item.business_line.name }}</span>
              {% endif %}
              {% if need.item.category %}
                <span class="badge badge-light rounded-pill me-1">Category: {{ need.item.category.name }}</span>
              {% endif %}
              {% if need.notes %}
                ¬∑ <em>{{ need.notes }}</em>
              {% endif %}
            </div>
          </div>

          <!-- Actions: stacks/responsive -->
          <div class="actions d-flex align-items-center gap-3 flex-wrap flex-md-nowrap mt-2 mt-md-0">
            <span class="qty-pill" x-text="'Qty: ' + qty"></span>

            <!-- Quantity controls -->
            <div class="btn-group qty-group" role="group" aria-label="Quantity">
              <button class="btn btn-outline-secondary btn-sm" type="button" @click="dec()" :disabled="loading">‚Äì</button>
              <span class="qty-display" x-text="qty"></span>
              <button class="btn btn-outline-secondary btn-sm" type="button" @click="inc()" :disabled="loading">+</button>
            </div>

            <!-- Primary action -->
            <button class="btn btn-success btn-sm flex-shrink-0" type="button"
                    @click="mark('PURCHASED')"
                    :disabled="loading">
              <span x-show="!loading">Purchased</span>
            </button>

            <!-- More -->
            <div class="dropdown flex-shrink-0">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" :disabled="loading">
                More
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" @click.prevent="mark('ORDERED')">Mark Ordered</a></li>
                <li><a class="dropdown-item text-muted" href="#" @click.prevent="mark('SKIPPED')">Skip</a></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Optional divider / future per-item extras -->
        <!-- <div class="row-divider"></div> -->
      </div>
      {% endfor %}
    </div>
  {% endif %}
</div>

<!-- Toast -->
<div id="toast"><div class="toast-card" x-data="{show:false}" x-show="show" x-transition.opacity></div></div>

<script>
function showToast(msg){
  const holder = document.querySelector('#toast');
  const card = holder.querySelector('.toast-card');
  card.textContent = msg;
  holder.style.display = 'block';
  card.__x ? card.__x.$data.show = true : null;
  setTimeout(()=>{ card.__x.$data.show = false; }, 1400);
  setTimeout(()=>{ holder.style.display = 'none'; }, 1650);
}

function rowState(itemId, initialQty){
  return {
    qty: Number(initialQty) || 1,
    loading: false,
    inc(){ this.qty = Math.max(1, this.qty + 1); },
    dec(){ this.qty = Math.max(1, this.qty - 1); },
    mark(status){
      const el = event?.currentTarget?.closest('.row-card') || null;
      this.loading = true;
      if(el) el.style.opacity = 0.8;

      fetch('/shopping/status', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ item_id: itemId, status: status, quantity: this.qty })
      })
      .then(async (r)=>{
        if(!r.ok) throw new Error(await r.text());
        // Remove row for terminal states, keep for ORDERED
        if(status==='PURCHASED' || status==='SKIPPED'){
          el?.remove();
          showToast(status==='PURCHASED' ? 'Marked purchased' : 'Skipped');
        } else {
          el && (el.style.opacity = 1);
          showToast('Marked ordered');
        }
      })
      .catch(()=>{
        el && (el.style.opacity = 1);
        alert('Update failed. Try again.');
      })
      .finally(()=>{ this.loading = false; });
    }
  }
}
</script>
{% endblock %}
