<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Task Templates</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 2rem; background-color: #f8f9fa; }
        .form-label { font-weight: 500; }
        .task-item-row { display: flex; gap: 1rem; align-items: center; margin-bottom: 0.5rem; }
        .task-item-row input, .task-item-row select { flex: 1; }
        .template-card { margin-bottom: 1.5rem; }
    </style>
</head>
<body>
<div class="container">
    <div class="text-end mb-3">
    <a href="/home" class="btn btn-sm btn-outline-primary">ğŸ  Home</a>
    </div>

    <!-- âœ… Flash success message -->
    {% if success %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        âœ… {{ success }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <h2 class="mb-4">ğŸ§© Task Template Manager</h2>

    <!-- âœ… Form to Create a New Template -->
    <form method="post" action="/tasks/admin/task-templates/create">
        <div class="mb-3">
            <label for="title" class="form-label">Template Title</label>
            <input type="text" class="form-control" name="title" required>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">Description (Optional)</label>
            <input type="text" class="form-control" name="description">
        </div>
        <div class="mb-3">
            <label for="auto_assign_label" class="form-label">Auto-Assign to Shift Label</label>
            <input type="text" class="form-control" name="auto_assign_label" placeholder="e.g. Morning Open">
            <div class="form-text">Leave blank if this template shouldnâ€™t be auto-attached.</div>
        </div>

        <div id="task-items" class="mb-3">
            <label class="form-label">Task Items</label>
            <!-- Initial task item row -->
            <div class="task-item-row">
                <input type="text" class="form-control" name="prompts" placeholder="Prompt" required>
                <select class="form-select" name="input_types">
                    <option value="checkbox">âœ… Checkbox</option>
                    <option value="text">ğŸ“ Text</option>
                    <option value="photo">ğŸ“· Photo</option>
                </select>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeTaskItem(this)">âŒ</button>
            </div>
        </div>
        <button type="button" class="btn btn-sm btn-secondary mb-3" onclick="addTaskItemToCreateForm()">â• Add Task Item</button>
        <br>
        <button type="submit" class="btn btn-primary">Create Template</button>
    </form>

    <hr class="my-5">

    <!-- âœ… Assign Template to a Shift -->
    <div class="card shadow-sm mb-5">
        <div class="card-body">
            <h5 class="card-title">ğŸ“ Assign Template to Shift</h5>
            <form method="post" action="/tasks/admin/tasks/assign">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="shift" class="form-label">Select Shift</label>
                        <select class="form-select" name="shift_id" required>
                            {% for shift in shifts %}
                            <option value="{{ shift.id }}">{{ shift.label }} - {{ shift.start_time.strftime('%b %d %I:%M %p') }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="template" class="form-label">Assign Task</label>
                        <select class="form-select" name="template_id" required>
                            {% for template in templates %}
                            <option value="{{ template.id }}">{{ template.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">âœ… Assign to Shift</button>
            </form>
        </div>
    </div>

    <!-- âœ… Existing Templates Loop -->
    <h4 class="mb-3">Existing Templates</h4>
    {% for template in templates %}
    <div class="card template-card shadow-sm" id="template-card-{{ template.id }}">
        <div class="card-body">

            <!-- ğŸ” View Mode -->
            <div id="view-mode-{{ template.id }}">
                <h5 class="card-title">{{ template.title }}</h5>
                <p class="card-text text-muted">{{ template.description or "No description" }}</p>
                <ul class="list-group mb-3">
                    {% for item in template.items %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ item.prompt }}
                        <span class="badge bg-light text-dark">{{ item.input_type }}</span>
                    </li>
                    {% endfor %}
                </ul>

                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleEdit('{{ template.id }}')">âœï¸ Edit</button>
                <form method="post" action="/tasks/admin/task-templates/{{ template.id }}/delete" class="d-inline">
                    <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Delete this template?')">ğŸ—‘ï¸ Delete</button>
                </form>
            </div>

            <!-- ğŸ›  Edit Mode -->
            <form method="post" action="/tasks/admin/task-templates/{{ template.id }}/update" id="edit-mode-{{ template.id }}" style="display:none;">
                <div class="mb-2">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control" name="title" value="{{ template.title }}" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-control" name="description" value="{{ template.description or '' }}">
                </div>
                <div class="mb-2">
                    <label class="form-label">Auto-Assign to Shift Label</label>
                    <input type="text" class="form-control" name="auto_assign_label" value="{{ template.auto_assign_label or '' }}">
                    <div class="form-text">Leave blank if not auto-assigned to a specific shift.</div>
                </div>

                <div class="mb-2">
                    <label class="form-label">Task Items</label>
                    <div id="edit-items-{{ template.id }}">
                        {% for item in template.items %}
                        <div class="task-item-row">
                            <input type="text" class="form-control" name="prompts" value="{{ item.prompt }}" required>
                            <select class="form-select" name="input_types">
                                <option value="checkbox" {% if item.input_type == 'checkbox' %}selected{% endif %}>âœ… Checkbox</option>
                                <option value="text" {% if item.input_type == 'text' %}selected{% endif %}>ğŸ“ Text</option>
                                <option value="photo" {% if item.input_type == 'photo' %}selected{% endif %}>ğŸ“· Photo</option>
                            </select>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeTaskItem(this)">âŒ</button>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="addTaskItem('edit-items-{{ template.id }}')">â• Add Item</button>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary btn-sm">ğŸ’¾ Save</button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="toggleEdit('{{ template.id }}')">Cancel</button>
                </div>
            </form>
        </div>
    </div>
{% endfor %}

<!-- âœ… JavaScript to support dynamic add/remove and toggle edit -->
<script>
  function addTaskItemToCreateForm() {
    const container = document.getElementById('task-items');
    const row = document.createElement('div');
    row.className = 'task-item-row';
    row.innerHTML = `
      <input type="text" class="form-control" name="prompts" placeholder="Prompt" required>
      <select class="form-select" name="input_types">
        <option value="checkbox">âœ… Checkbox</option>
        <option value="text">ğŸ“ Text</option>
        <option value="photo">ğŸ“· Photo</option>
      </select>
      <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeTaskItem(this)">âŒ</button>
    `;
    container.appendChild(row);
  }

  function addTaskItem(containerId) {
    const container = document.getElementById(containerId);
    const row = document.createElement('div');
    row.className = 'task-item-row';
    row.innerHTML = `
      <input type="text" class="form-control" name="prompts" placeholder="Prompt" required>
      <select class="form-select" name="input_types">
        <option value="checkbox">âœ… Checkbox</option>
        <option value="text">ğŸ“ Text</option>
        <option value="photo">ğŸ“· Photo</option>
      </select>
      <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeTaskItem(this)">âŒ</button>
    `;
    container.appendChild(row);
  }

  function removeTaskItem(button) {
    button.parentElement.remove();
  }

  function toggleEdit(templateId) {
    const view = document.getElementById(`view-mode-${templateId}`);
    const edit = document.getElementById(`edit-mode-${templateId}`);
    view.style.display = view.style.display === 'none' ? 'block' : 'none';
    edit.style.display = edit.style.display === 'none' ? 'block' : 'none';
  }
</script>


</body>
</html>
