{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <!-- üîô Back Home -->
  <div class="text-end mb-3">
    <a href="/admin/dashboard" class="btn btn-sm btn-outline-secondary">üè† Home</a>
  </div>

  <!-- üì• Log Submission Form -->
  <div class="card mb-5 shadow-sm">
    <div class="card-header bg-light">
      <h5 class="mb-0">üßä Submit Vending Machine Log</h5>
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data">
        <div class="mb-3">
          <label for="machine_id" class="form-label">Machine Location</label>
          <select name="machine_id" class="form-select" required>
            <option disabled selected value="">Select a machine</option>
            {% for machine in machines %}
              <option value="{{ machine.id }}">{{ machine.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label for="notes" class="form-label">Notes</label>
          <textarea name="notes" class="form-control" rows="2" placeholder="E.g. Restock Kit-Kats, grab Pelligrino"></textarea>
        </div>

        <div class="mb-3">
          <label for="photos" class="form-label">Photos (Snack + Beverage)</label>
          <input type="file" name="photos" class="form-control" multiple>
        </div>

        <button type="submit" class="btn btn-primary">Submit Log</button>
      </form>
    </div>
  </div>

  <!-- üì¶ Logs by Machine -->
  {% for machine_name, sources in grouped_logs.items() %}
  <details class="mb-4 border rounded p-3 bg-light">
    <summary class="h5 mb-2">üè≠ {{ machine_name }}</summary>

    <!-- Internal Logs -->
    <div class="mt-3">
      <h6 class="fw-bold">üõ†Ô∏è Internal Logs (Showing most recent 3)</h6>
      {% if sources.internal %}
        {% for log in sources.internal[:3] %}
          <p><strong>{{ log.timestamp.strftime('%b %d, %I:%M %p') }}</strong>: {{ log.notes or "‚Äî" }}</p>
          {% if log.photo_filename %}
            {% for photo in log.photo_filename.split(',') %}
              <img src="/static/vending_logs/{{ photo.strip() }}" class="img-thumbnail mb-2 me-2" style="max-height: 150px;" />
            {% endfor %}
          {% else %}
            <p class="text-muted small">No photos uploaded.</p>
          {% endif %}
          <hr>
        {% endfor %}
      {% else %}
        <p class="text-muted">No internal logs available.</p>
      {% endif %}
    </div>

    <!-- QR Logs -->
    <div class="mt-3">
      <h6 class="fw-bold">üîó QR Submissions ({{ sources.qr | length }})</h6>
      {% if sources.qr %}
        {% for log in sources.qr %}
          <p><strong>{{ log.timestamp.strftime('%b %d, %I:%M %p') }}</strong>: {{ log.issue_type }} ‚Äî {{ log.notes or "‚Äî" }}</p>
          {% if log.photo_filename %}
            {% if ',' in log.photo_filename %}
              {% for photo in log.photo_filename.split(',') %}
                <img src="/static/vending_logs/vending_qr_photos/{{ photo.strip() }}" class="img-thumbnail mb-2 me-2" style="max-height: 150px;" />
              {% endfor %}
            {% else %}
              <img src="/static/vending_logs/vending_qr_photos/{{ log.photo_filename }}" class="img-thumbnail mb-2" style="max-height: 150px;" />
            {% endif %}
          {% else %}
            <p class="text-muted small">No photo uploaded.</p>
          {% endif %}
          {% if log.email %}
            <p class="text-muted small">üìß {{ log.email }}</p>
          {% endif %}
          <hr>
        {% endfor %}
      {% else %}
        <p class="text-muted">No QR submissions available.</p>
      {% endif %}
    </div>
  </details>
  {% endfor %}

</div>
{% endblock %}
