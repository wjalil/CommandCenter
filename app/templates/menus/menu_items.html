{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h2 class="mb-0">üçΩÔ∏è Menu Items</h2>
      <div class="text-muted small">Manage items by menu</div>
    </div>
    <div class="d-flex gap-2">
      <a href="/admin/menus" class="btn btn-outline-secondary">‚Üê Back to Menus</a>
    </div>
  </div>

  {% if request.query_params.get("success") %}
    <div class="alert alert-success">{{ request.query_params.get("success") }}</div>
  {% endif %}
  {% if request.query_params.get("error") %}
    <div class="alert alert-danger">{{ request.query_params.get("error") }}</div>
  {% endif %}

  {% for menu in menus %}
    {% set categories = menu_categories_map.get(menu.id, []) if menu_categories_map is defined else [] %}

    <div class="card shadow-sm mb-4" x-data="menuItemsPage({{ menu.id|tojson }})">
      <div class="card-body">

        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <div class="d-flex align-items-center gap-2">
            <h4 class="mb-0">{{ menu.name }}</h4>
            {% if menu.is_active %}
              <span class="badge bg-success">Active</span>
            {% else %}
              <span class="badge bg-secondary">Inactive</span>
            {% endif %}
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-secondary" type="button" @click="addRow()">+ Add Row</button>
            <button class="btn btn-sm btn-primary" type="button" @click="submitNewItems()" :disabled="newItems.length === 0">
              Save New Items
            </button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered align-middle text-center">
            <thead class="table-light">
              <tr>
                <th style="min-width:160px;">Name</th>
                <th style="min-width:220px;">Description</th>
                <th style="width:120px;">Price</th>
                <th style="width:100px;">Qty</th>
                <th style="min-width:180px;">Category</th>
                <th style="width:110px;">Photo</th>
                <th style="width:170px;">Actions</th>
              </tr>
            </thead>

            <tbody>
              {% for item in menu.items %}

                {# ---- CATEGORY LABEL (namespace fixes Jinja loop scoping) ---- #}
                {% set ns = namespace(label="‚Äî") %}
                {% if item.category_id %}
                  {% for cat in categories %}
                    {% if cat.id == item.category_id %}
                      {% set ns.label = cat.name %}
                    {% endif %}
                  {% endfor %}
                {% endif %}

                <tr
                  x-data="menuItemRow($el)"
                  data-item-id="{{ item.id }}"
                  data-name="{{ item.name|e }}"
                  data-description="{{ (item.description or '')|e }}"
                  data-price="{{ item.price }}"
                  data-qty="{{ item.qty_available }}"
                  data-category-id="{{ item.category_id or '' }}"
                >
                  <td class="text-start">
                    <div x-show="!editable" class="fw-semibold">{{ item.name }}</div>
                    <div x-show="editable">
                      <input class="form-control" x-model="form.name">
                    </div>
                  </td>

                  <td class="text-start">
                    <div x-show="!editable">{{ item.description or "‚Äî" }}</div>
                    <div x-show="editable">
                      <input class="form-control" x-model="form.description">
                    </div>
                  </td>

                  <td>
                    <div x-show="!editable">${{ "%.2f"|format(item.price or 0) }}</div>
                    <div x-show="editable">
                      <input type="number" step="0.01" min="0" class="form-control" x-model="form.price">
                    </div>
                  </td>

                  <td>
                    <div x-show="!editable">{{ item.qty_available }}</div>
                    <div x-show="editable">
                      <input type="number" min="0" step="1" class="form-control" x-model="form.qty_available">
                    </div>
                  </td>

                  <td class="text-start">
                    <div x-show="!editable">{{ ns.label }}</div>
                    <div x-show="editable">
                      <select class="form-select" x-model="form.category_id">
                        <option value="">‚Äî</option>
                        {% for cat in categories %}
                          <option value="{{ cat.id }}">{{ cat.name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </td>

                  <td>
                    {% if item.photo_filename %}
                      <img
                        src="https://commandcenter-media.nyc3.cdn.digitaloceanspaces.com/{{ item.photo_filename }}"
                        class="img-thumbnail"
                        style="max-width:70px; height:auto;"
                      >
                    {% else %}
                      ‚Äî
                    {% endif %}
                  </td>

                  <td class="d-flex justify-content-center gap-2">
                    <button x-show="editable" class="btn btn-sm btn-success" type="button" @click="updateItem()">üíæ</button>

                    <button class="btn btn-sm btn-outline-primary" type="button"
                            @click="editable = !editable"
                            x-text="editable ? 'Cancel' : '‚úèÔ∏è Edit'"></button>

                    <form method="post" action="/admin/menu-items/{{ item.id }}/delete"
                          onsubmit="return confirm('Delete this item?');">
                      <button type="submit" class="btn btn-sm btn-outline-danger">üóëÔ∏è</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}

              <!-- New bulk rows -->
              <template x-for="(item, index) in newItems" :key="index">
                <tr>
                  <td><input class="form-control" x-model="item.name"></td>
                  <td><input class="form-control" x-model="item.description"></td>
                  <td><input class="form-control" type="number" step="0.01" x-model.number="item.price"></td>
                  <td><input class="form-control" type="number" step="1" x-model.number="item.qty_available"></td>
                  <td class="text-start">
                    <select class="form-select" x-model="item.category_id">
                      <option value="">‚Äî</option>
                      {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                      {% endfor %}
                    </select>
                  </td>
                  <td>‚Äî</td>
                  <td>
                    <button class="btn btn-sm btn-outline-danger" type="button" @click="newItems.splice(index,1)">‚úï</button>
                  </td>
                </tr>
              </template>

            </tbody>
          </table>
        </div>

        <hr class="my-4">

        <h5>Add a single item</h5>
        <form method="post" action="/admin/menu-items/create" enctype="multipart/form-data">
          <input type="hidden" name="menu_id" value="{{ menu.id }}">

          <div class="row g-2 align-items-end">
            <div class="col-md-3">
              <label class="form-label small">Name</label>
              <input class="form-control" name="name" required>
            </div>

            <div class="col-md-3">
              <label class="form-label small">Description</label>
              <input class="form-control" name="description">
            </div>

            <div class="col-md-2">
              <label class="form-label small">Price</label>
              <input class="form-control" type="number" step="0.01" min="0" name="price" required>
            </div>

            <div class="col-md-2">
              <label class="form-label small">Qty</label>
              <input class="form-control" type="number" step="1" min="0" name="quantity" required>
            </div>

            <div class="col-md-2">
              <label class="form-label small">Category</label>
              <select class="form-select" name="category_id">
                <option value="">‚Äî</option>
                {% for cat in categories %}
                  <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label small">Photo</label>
              <input class="form-control" type="file" name="photo">
            </div>

            <div class="col-md-2">
              <button class="btn btn-success w-100" type="submit">Add Item</button>
            </div>
          </div>
        </form>

      </div>
    </div>
  {% endfor %}
</div>

<script>
function menuItemsPage(menuId) {
  return {
    newItems: [],
    addRow() {
      this.newItems.push({ name:"", description:"", price:0, qty_available:0, category_id:"" });
    },
    async submitNewItems() {
      const r = await fetch("/admin/menu-items/bulk-create", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ menu_id:menuId, items:this.newItems })
      });
      if (r.ok) location.reload();
      else alert("Failed to add items");
    }
  }
}

function menuItemRow(el) {
  return {
    editable:false,
    form:{
      name: el.dataset.name || "",
      description: el.dataset.description || "",
      price: el.dataset.price || 0,
      qty_available: parseInt(el.dataset.qty || "0", 10),
      category_id: el.dataset.categoryId || ""
    },
    async updateItem() {
      const r = await fetch(`/admin/menu-items/${el.dataset.itemId}/inline-update`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(this.form)
      });
      if (r.ok) location.reload();
      else alert("Update failed");
    }
  }
}
</script>
{% endblock %}
