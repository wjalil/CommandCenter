{% extends "base.html" %}
{% block title %}Catering Invoices{% endblock %}

{% block content %}
{% set active = 'invoices' %}
{% include "catering/_nav.html" %}

<div class="row mb-4">
  <div class="col-md-8">
    <h2>Catering Invoices</h2>
    <p class="text-muted">Invoices organized by program</p>
  </div>
</div>

{% if request.query_params.get('message') %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
  {{ request.query_params.get('message') }}
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}
{% if request.query_params.get('error') %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
  {{ request.query_params.get('error') }}
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if programs_with_invoices %}
<div class="accordion" id="invoiceAccordion">
  {% for program, invoices in programs_with_invoices %}
  <div class="accordion-item mb-3 border rounded">
    <h2 class="accordion-header" id="heading-{{ loop.index }}">
      <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button"
              data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}"
              aria-expanded="{{ 'true' if loop.first else 'false' }}" aria-controls="collapse-{{ loop.index }}">
        <span class="fw-bold me-2">{{ program.name }}</span>
        <span class="badge bg-secondary me-2">{{ invoices|length }} invoice{{ 's' if invoices|length != 1 }}</span>
      </button>
    </h2>
    <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
         aria-labelledby="heading-{{ loop.index }}" data-bs-parent="#invoiceAccordion">
      <div class="accordion-body p-0">
        <div class="d-flex justify-content-end p-3 pb-0">
          <a href="/catering/invoices/program/{{ program.id }}/download-all" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-file-earmark-zip"></i> Download All PDFs (.zip)
          </a>
        </div>
        <div class="table-responsive">
          <table class="nice-table mb-0">
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Service Date</th>
                <th>Meals</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for invoice in invoices %}
              <tr>
                <td><strong>{{ invoice.invoice_number }}</strong></td>
                <td>{{ invoice.service_date.strftime('%b %d, %Y') }}</td>
                <td>
                  {{ invoice.regular_meal_count }} regular
                  {% if invoice.vegan_meal_count > 0 %}
                  <br><small class="text-success">+ {{ invoice.vegan_meal_count }} vegan</small>
                  {% endif %}
                </td>
                <td>
                  {% if invoice.status == 'draft' %}
                  <span class="badge bg-secondary">Draft</span>
                  {% elif invoice.status == 'finalized' %}
                  <span class="badge bg-success">Finalized</span>
                  {% elif invoice.status == 'sent' %}
                  <span class="badge bg-primary">Sent</span>
                  {% elif invoice.status == 'paid' %}
                  <span class="badge bg-success">Paid</span>
                  {% endif %}
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <a href="/catering/invoices/{{ invoice.id }}/view" class="btn btn-outline-primary">View</a>
                    <a href="/catering/invoices/{{ invoice.id }}/pdf" class="btn btn-outline-secondary">PDF</a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="alert alert-info">
  <h5>No Invoices Yet</h5>
  <p>Invoices can be generated from monthly menus or created manually.</p>
  <a href="/catering/monthly-menus" class="btn btn-primary">View Menus</a>
</div>
{% endif %}
{% endblock %}
