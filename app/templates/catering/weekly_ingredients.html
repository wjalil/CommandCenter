{% extends "base.html" %}

{% block title %}
{% if is_aggregate %}Shopping List - {{ month_name }} {{ year }}{% else %}Ingredients - {{ program.name }}{% endif %}
{% endblock %}

{% block content %}
{% set active = 'shopping' %}
{% include "catering/_nav.html" %}

<div class="container-fluid">

  <!-- Header -->
  <div class="row mb-3">
    <div class="col-md-6">
      {% if is_aggregate %}
        <h2>Shopping List</h2>
        <p class="text-muted mb-0">
          {{ month_name }} {{ year }} - {{ total_ingredients }} unique ingredients
          {% if programs_included %}
            across {{ programs_included|length }} program{% if programs_included|length > 1 %}s{% endif %}
          {% endif %}
        </p>
      {% else %}
        <h2>Ingredient List</h2>
        <p class="text-muted mb-0">
          {{ program.name }} - {{ month_name }} {{ year }} ({{ total_ingredients }} items)
        </p>
      {% endif %}
    </div>
    <div class="col-md-6 text-end">
      {% if menu_id %}
        <a href="/catering/monthly-menus/{{ menu_id }}/calendar" class="btn btn-outline-secondary btn-sm">Back to Calendar</a>
      {% endif %}
      <button class="btn btn-outline-primary btn-sm" onclick="window.print()">Print</button>
    </div>
  </div>

  {% if is_aggregate %}
  <!-- Filters for aggregate view -->
  <div class="card mb-3">
    <div class="card-body py-2">
      <form method="GET" class="row g-2 align-items-center">
        <div class="col-auto">
          <label class="col-form-label">Month:</label>
        </div>
        <div class="col-auto">
          <select name="month" class="form-select form-select-sm">
            {% for m in range(1, 13) %}
              <option value="{{ m }}" {% if m == month %}selected{% endif %}>
                {{ ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"][m-1] }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-auto">
          <select name="year" class="form-select form-select-sm">
            {% for y in range(year - 1, year + 3) %}
              <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-auto">
          <label class="col-form-label">Program:</label>
        </div>
        <div class="col-auto">
          <select name="program_id" class="form-select form-select-sm">
            <option value="">All Programs</option>
            {% for prog in all_programs %}
              <option value="{{ prog.id }}" {% if selected_program_id == prog.id %}selected{% endif %}>
                {{ prog.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-sm btn-primary">Apply</button>
        </div>
      </form>
    </div>
  </div>

  {% if programs_included %}
  <div class="mb-3">
    <small class="text-muted">
      Including:
      {% for prog in programs_included %}
        <span class="badge bg-secondary">{{ prog.name }}</span>
      {% endfor %}
    </small>
  </div>
  {% endif %}
  {% endif %}

  <!-- Meal Filter Tabs -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="btn-group" role="group" aria-label="Meal filter">
        <input type="radio" class="btn-check" name="mealFilter" id="filterAll" value="all" checked>
        <label class="btn btn-outline-primary" for="filterAll">All</label>

        <input type="radio" class="btn-check" name="mealFilter" id="filterBreakfast" value="breakfast">
        <label class="btn btn-outline-warning" for="filterBreakfast">Breakfast</label>

        <input type="radio" class="btn-check" name="mealFilter" id="filterLunch" value="lunch">
        <label class="btn btn-outline-success" for="filterLunch">Lunch</label>

        <input type="radio" class="btn-check" name="mealFilter" id="filterSnack" value="snack">
        <label class="btn btn-outline-info" for="filterSnack">Snack</label>
      </div>
    </div>
  </div>

  {% if not weeks %}
    <div class="alert alert-info">
      No menu items have been assigned for this period. Create menus and add items to see the shopping list.
    </div>
  {% else %}
    <!-- Weeks -->
    {% for week in weeks %}
      <div class="card mb-4 shadow-sm week-card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <strong>Week of {{ week.week_start.strftime('%B %d') }} - {{ week.week_end.strftime('%B %d') }}</strong>
          <span class="badge bg-secondary item-count"
                data-all="{{ week.ingredients|length }}"
                data-breakfast="{{ week.by_meal.breakfast|length }}"
                data-lunch="{{ week.by_meal.lunch|length }}"
                data-snack="{{ week.by_meal.snack|length }}">
            {{ week.ingredients|length }} items
          </span>
        </div>

        <div class="card-body">
          {% set week_idx = loop.index %}
          <!-- All Ingredients -->
          <div class="ingredient-section" data-meal="all">
            {% if week.ingredients %}
              <div class="row">
                {% for ingredient in week.ingredients %}
                  <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input ingredient-check" id="all-{{ week_idx }}-{{ loop.index }}">
                      <label class="form-check-label ingredient-label" for="all-{{ week_idx }}-{{ loop.index }}">{{ ingredient }}</label>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted mb-0">No ingredients for this week.</p>
            {% endif %}
          </div>

          <!-- Breakfast -->
          <div class="ingredient-section" data-meal="breakfast" style="display: none;">
            {% if week.by_meal.breakfast %}
              <div class="row">
                {% for ingredient in week.by_meal.breakfast %}
                  <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input ingredient-check" id="bf-{{ week_idx }}-{{ loop.index }}">
                      <label class="form-check-label ingredient-label" for="bf-{{ week_idx }}-{{ loop.index }}">{{ ingredient }}</label>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted mb-0">No breakfast ingredients.</p>
            {% endif %}
          </div>

          <!-- Lunch -->
          <div class="ingredient-section" data-meal="lunch" style="display: none;">
            {% if week.by_meal.lunch %}
              <div class="row">
                {% for ingredient in week.by_meal.lunch %}
                  <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input ingredient-check" id="ln-{{ week_idx }}-{{ loop.index }}">
                      <label class="form-check-label ingredient-label" for="ln-{{ week_idx }}-{{ loop.index }}">{{ ingredient }}</label>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted mb-0">No lunch ingredients.</p>
            {% endif %}
          </div>

          <!-- Snack -->
          <div class="ingredient-section" data-meal="snack" style="display: none;">
            {% if week.by_meal.snack %}
              <div class="row">
                {% for ingredient in week.by_meal.snack %}
                  <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input ingredient-check" id="sn-{{ week_idx }}-{{ loop.index }}">
                      <label class="form-check-label ingredient-label" for="sn-{{ week_idx }}-{{ loop.index }}">{{ ingredient }}</label>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted mb-0">No snack ingredients.</p>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  {% endif %}

</div>

<style>
  .ingredient-check:checked + .ingredient-label {
    text-decoration: line-through;
    color: #6c757d;
  }

  @media print {
    .btn, nav, .navbar, .sidebar, .btn-group, .card.mb-3:first-of-type { display: none !important; }
    .card { break-inside: avoid; }
    .form-check-input { display: inline-block !important; }
    .ingredient-section[style*="display: none"] { display: none !important; }
  }
</style>

<script>
document.querySelectorAll('input[name="mealFilter"]').forEach(radio => {
  radio.addEventListener('change', function() {
    const meal = this.value;

    document.querySelectorAll('.ingredient-section').forEach(section => {
      section.style.display = section.dataset.meal === meal ? 'block' : 'none';
    });

    document.querySelectorAll('.item-count').forEach(badge => {
      const count = badge.dataset[meal];
      badge.textContent = count + ' items';
    });
  });
});
</script>

{% endblock %}
