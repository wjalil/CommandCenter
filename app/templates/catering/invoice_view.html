{% extends "base.html" %}
{% block title %}Invoice {{ invoice.invoice_number }}{% endblock %}

{% block content %}
{% set active = 'invoices' %}
{% include "catering/_nav.html" %}

<div class="row mb-3">
  <div class="col-md-12">
    <a href="/catering/invoices/{{ invoice.id }}/pdf" class="btn btn-primary btn-sm">Download PDF</a>
    <button class="btn btn-success btn-sm" onclick="window.print()">Print</button>
    <form method="POST" action="/catering/invoices/{{ invoice.id }}/delete" style="display: inline;" onsubmit="return confirm('Delete this invoice?');">
      <button type="submit" class="btn btn-danger btn-sm">Delete</button>
    </form>
  </div>
</div>

<!-- Invoice Document (print-friendly) -->
<div class="invoice-document" style="max-width: 800px; margin: 0 auto; background: white; padding: 40px; border: 1px solid #ddd;">

  <div class="text-center mb-4">
    <h2 style="font-size: 28px; margin-bottom: 5px;">DELIVERY INVOICE</h2>
  </div>

  <table style="width: 100%; margin-bottom: 20px;" class="table-borderless">
    <tr>
      <td style="width: 50%; vertical-align: top;">
        <p style="margin-bottom: 5px;"><strong>DATE:</strong></p>
        <p style="margin-bottom: 15px;">{{ invoice.service_date.strftime('%Y-%m-%d') }}</p>

        <p style="margin-bottom: 5px;"><strong>INVOICE NUMBER:</strong></p>
        <p style="margin-bottom: 15px;">{{ invoice.invoice_number }}</p>
      </td>
      <td style="width: 50%; vertical-align: top;">
        <p style="margin-bottom: 5px;"><strong>CUSTOMER:</strong></p>
        <p style="margin-bottom: 0;">{{ invoice.program.client_name }}</p>
        <p style="margin-bottom: 0;"><strong>TO:</strong></p>
        <p style="margin-bottom: 15px;">{{ invoice.program.name }}<br>{{ invoice.program.address or '' }}</p>
      </td>
    </tr>
  </table>

  <div style="margin-bottom: 20px;">
    <p style="margin-bottom: 5px;"><strong>VENDOR:</strong></p>
    <p style="margin-bottom: 0;">Chai and Biscuit LLC</p>
    <p style="margin-bottom: 0;">6014 Fresh Pond Rd, Maspeth, NY, 11378</p>
  </div>

  <table style="width: 100%; border-collapse: collapse; margin: 20px 0;" class="table table-bordered">
    <thead style="background-color: #f8f9fa;">
      <tr>
        <th style="padding: 10px; border: 1px solid #dee2e6; width: 80px;">QTY</th>
        <th style="padding: 10px; border: 1px solid #dee2e6;">DESCRIPTION</th>
      </tr>
    </thead>
    <tbody>
      {% if menu_day %}
        {# Check if using component-first mode #}
        {% set has_components = menu_day.components and menu_day.components|length > 0 %}

        {% if has_components %}
          {# Component-first mode: group by meal_slot with CACFP portions #}

          {# Breakfast - Regular #}
          {% set breakfast_comps = menu_day.components|selectattr('meal_slot', 'equalto', 'breakfast')|selectattr('is_vegan', 'equalto', false)|list %}
          {% if breakfast_comps and invoice.breakfast_count %}
          <tr>
            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">{{ invoice.breakfast_count }}</td>
            <td style="padding: 10px; border: 1px solid #dee2e6;">
              <strong>Breakfast</strong> (
              {%- for comp in breakfast_comps|sort(attribute='sort_order') -%}
                {{ comp.food_component.name }} {{ (comp.quantity or comp.food_component.default_portion_oz)|float }}oz
                {%- if not loop.last %}, {% endif -%}
              {%- endfor -%}
              )
            </td>
          </tr>
          {% endif %}

          {# Breakfast - Vegan #}
          {% set breakfast_vegan_comps = menu_day.components|selectattr('meal_slot', 'equalto', 'breakfast')|selectattr('is_vegan', 'equalto', true)|list %}
          {% if breakfast_vegan_comps and invoice.breakfast_vegan_count > 0 %}
          <tr>
            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">{{ invoice.breakfast_vegan_count }}</td>
            <td style="padding: 10px; border: 1px solid #dee2e6;">
              <strong>Breakfast - Vegan</strong> (
              {%- for comp in breakfast_vegan_comps|sort(attribute='sort_order') -%}
                {{ comp.food_component.name }} {{ (comp.quantity or comp.food_component.default_portion_oz)|float }}oz
                {%- if not loop.last %}, {% endif -%}
              {%- endfor -%}
              )
            </td>
          </tr>
          {% endif %}

          {# Lunch - Regular #}
          {% set lunch_comps = menu_day.components|selectattr('meal_slot', 'equalto', 'lunch')|selectattr('is_vegan', 'equalto', false)|list %}
          {% if lunch_comps and invoice.lunch_count and invoice.lunch_count > 0 %}
          <tr>
            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">{{ invoice.lunch_count }}</td>
            <td style="padding: 10px; border: 1px solid #dee2e6;">
              <strong>Lunch</strong> (
              {%- for comp in lunch_comps|sort(attribute='sort_order') -%}
                {{ comp.food_component.name }} {{ (comp.quantity or comp.food_component.default_portion_oz)|float }}oz
                {%- if not loop.last %}, {% endif -%}
              {%- endfor -%}
              )
            </td>
          </tr>
          {% endif %}

          {# Lunch - Vegan #}
          {% set lunch_vegan_comps = menu_day.components|selectattr('meal_slot', 'equalto', 'lunch')|selectattr('is_vegan', 'equalto', true)|list %}
          {% if lunch_vegan_comps and invoice.lunch_vegan_count > 0 %}
          <tr>
            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">{{ invoice.lunch_vegan_count }}</td>
            <td style="padding: 10px; border: 1px solid #dee2e6;">
              <strong>Lunch - Vegan</strong> (
              {%- for comp in lunch_vegan_comps|sort(attribute='sort_order') -%}
                {{ comp.food_component.name }} {{ (comp.quantity or comp.food_component.default_portion_oz)|float }}oz
                {%- if not loop.last %}, {% endif -%}
              {%- endfor -%}
              )
            </td>
          </tr>
          {% endif %}

          {# Snack - Regular #}
          {% set snack_comps = menu_day.components|selectattr('meal_slot', 'equalto', 'snack')|selectattr('is_vegan', 'equalto', false)|list %}
          {% if snack_comps and invoice.snack_count %}
          <tr>
            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">{{ invoice.snack_count }}</td>
            <td style="padding: 10px; border: 1px solid #dee2e6;">
              <strong>Snack</strong> (
              {%- for comp in snack_comps|sort(attribute='sort_order') -%}
                {{ comp.food_component.name }} {{ (comp.quantity or comp.food_component.default_portion_oz)|float }}oz
                {%- if not loop.last %}, {% endif -%}
              {%- endfor -%}
              )
            </td>
          </tr>
          {% endif %}

          {# Snack - Vegan #}
          {% set snack_vegan_comps = menu_day.components|selectattr('meal_slot', 'equalto', 'snack')|selectattr('is_vegan', 'equalto', true)|list %}
          {% if snack_vegan_comps and invoice.snack_vegan_count > 0 %}
          <tr>
            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">{{ invoice.snack_vegan_count }}</td>
            <td style="padding: 10px; border: 1px solid #dee2e6;">
              <strong>Snack - Vegan</strong> (
              {%- for comp in snack_vegan_comps|sort(attribute='sort_order') -%}
                {{ comp.food_component.name }} {{ (comp.quantity or comp.food_component.default_portion_oz)|float }}oz
                {%- if not loop.last %}, {% endif -%}
              {%- endfor -%}
              )
            </td>
          </tr>
          {% endif %}

        {% else %}
          {# Pre-built meal item mode #}

          <!-- Breakfast -->
          {% if menu_day.breakfast_item and invoice.breakfast_count %}
          <tr>
            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">{{ invoice.breakfast_count }}</td>
            <td style="padding: 10px; border: 1px solid #dee2e6;">
              <strong>Breakfast</strong> (
              {%- if menu_day.breakfast_item.components -%}
                {%- for comp in menu_day.breakfast_item.components -%}
                  {{ comp.food_component.name }} {{ comp.portion_oz }}oz
                  {%- if not loop.last %}, {% endif -%}
                {%- endfor -%}
              {%- else -%}
                {{ menu_day.breakfast_item.name }}
              {%- endif -%}
              )
            </td>
          </tr>
          {% endif %}

          <!-- Lunch - Regular -->
          {% if menu_day.lunch_item and invoice.lunch_count and invoice.lunch_count > 0 %}
          <tr>
            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">{{ invoice.lunch_count }}</td>
            <td style="padding: 10px; border: 1px solid #dee2e6;">
              <strong>Lunch</strong> (
              {%- if menu_day.lunch_item.components -%}
                {%- for comp in menu_day.lunch_item.components -%}
                  {{ comp.food_component.name }} {{ comp.portion_oz }}oz
                  {%- if not loop.last %}, {% endif -%}
                {%- endfor -%}
              {%- else -%}
                {{ menu_day.lunch_item.name }}
              {%- endif -%}
              )
            </td>
          </tr>
          {% endif %}

          <!-- Lunch - Vegan -->
          {% if menu_day.lunch_vegan_item and invoice.lunch_vegan_count > 0 %}
          <tr>
            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">{{ invoice.lunch_vegan_count }}</td>
            <td style="padding: 10px; border: 1px solid #dee2e6;">
              <strong>Lunch - Vegan</strong> (
              {%- if menu_day.lunch_vegan_item.components -%}
                {%- for comp in menu_day.lunch_vegan_item.components -%}
                  {{ comp.food_component.name }} {{ comp.portion_oz }}oz
                  {%- if not loop.last %}, {% endif -%}
                {%- endfor -%}
              {%- else -%}
                {{ menu_day.lunch_vegan_item.name }}
              {%- endif -%}
              )
            </td>
          </tr>
          {% endif %}

          <!-- Snack -->
          {% if menu_day.snack_item and invoice.snack_count %}
          <tr>
            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">{{ invoice.snack_count }}</td>
            <td style="padding: 10px; border: 1px solid #dee2e6;">
              <strong>Snack</strong> (
              {%- if menu_day.snack_item.components -%}
                {%- for comp in menu_day.snack_item.components -%}
                  {{ comp.food_component.name }} {{ comp.portion_oz }}oz
                  {%- if not loop.last %}, {% endif -%}
                {%- endfor -%}
              {%- else -%}
                {{ menu_day.snack_item.name }}
              {%- endif -%}
              )
            </td>
          </tr>
          {% endif %}
        {% endif %}

      {% endif %}
    </tbody>
  </table>

  <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 2px solid #333;">
    <p style="font-weight: bold; margin-bottom: 10px;">THANK YOU FOR YOUR BUSINESS!</p>
    <p style="margin-bottom: 5px;">CHAI AND BISCUIT LLC</p>
    <p style="margin-bottom: 20px;">6014 FRESH POND RD. | MASPETH, QUEENS, 11378 | PHONE: 347-738-5048</p>
  </div>

  <div style="margin-top: 40px;">
    <p style="margin-bottom: 5px;"><strong>RECIPIENT NAME/SIGNATURE</strong></p>
    <p style="border-bottom: 1px solid #000; padding-bottom: 2px; margin-bottom: 5px;">X_____________________________________________</p>
  </div>

</div>

<style>
@media print {
  .btn, nav, .navbar, .sidebar { display: none !important; }
  .invoice-document { border: none !important; box-shadow: none !important; }
}
</style>

{% endblock %}
