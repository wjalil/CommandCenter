{% extends "base.html" %}
{% block title %}Delivery Routes{% endblock %}

{% block content %}
{% set active = 'routes' %}
{% include "delivery/_nav.html" %}

<div class="row mb-4">
  <div class="col-md-6">
    <h2>Delivery Routes</h2>
    <p class="text-muted">Manage daily delivery routes</p>
  </div>
  <div class="col-md-6 text-end">
    <a href="/delivery/admin/routes/create" class="btn btn-primary">+ Create Route</a>
  </div>
</div>

<!-- Date Filter -->
<div class="row mb-3">
  <div class="col-md-4">
    <form method="GET" class="d-flex gap-2">
      <input type="date" name="filter_date" class="form-control" value="{{ filter_date }}">
      <button type="submit" class="btn btn-outline-secondary">Filter</button>
      {% if filter_date %}
      <a href="/delivery/admin/routes" class="btn btn-outline-secondary">Clear</a>
      {% endif %}
    </form>
  </div>
</div>

{% if routes %}
<table class="nice-table">
  <thead>
    <tr>
      <th>Date</th>
      <th>Name</th>
      <th>Driver</th>
      <th>Stops</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for route in routes %}
    <tr>
      <td>
        <strong>{{ route.date.strftime('%a, %b %d') }}</strong><br>
        <small class="text-muted">{{ route.date.strftime('%Y') }}</small>
      </td>
      <td>{{ route.name }}</td>
      <td>
        {% if route.assigned_driver %}
        {{ route.assigned_driver.name }}
        {% else %}
        <span class="text-muted">Unassigned</span>
        {% endif %}
      </td>
      <td>
        {{ route.route_stops|length }} stop{% if route.route_stops|length != 1 %}s{% endif %}
        {% if route.route_stops %}
        <br><small class="text-muted">
          {% for rs in route.route_stops[:2] %}{{ rs.stop.name }}{% if not loop.last %}, {% endif %}{% endfor %}
          {% if route.route_stops|length > 2 %}...{% endif %}
        </small>
        {% endif %}
      </td>
      <td>
        {% if route.status == 'draft' %}
        <span class="badge bg-secondary">Draft</span>
        {% elif route.status == 'assigned' %}
        <span class="badge bg-info">Assigned</span>
        {% elif route.status == 'in_progress' %}
        <span class="badge bg-warning">In Progress</span>
        {% elif route.status == 'completed' %}
        <span class="badge bg-success">Completed</span>
        {% else %}
        <span class="badge bg-secondary">{{ route.status }}</span>
        {% endif %}
      </td>
      <td>
        <div class="btn-group btn-group-sm">
          <a href="/delivery/admin/routes/{{ route.id }}/edit" class="btn btn-outline-primary">Edit</a>
          <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#duplicateModal{{ route.id }}">
            Duplicate
          </button>
          <form action="/delivery/admin/routes/{{ route.id }}/delete" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-outline-danger btn-sm"
                    onclick="return confirm('Delete this route?')">Delete</button>
          </form>
        </div>
      </td>
    </tr>

    <!-- Duplicate Modal -->
    <div class="modal fade" id="duplicateModal{{ route.id }}" tabindex="-1">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <form action="/delivery/admin/routes/{{ route.id }}/duplicate" method="POST">
            <div class="modal-header">
              <h5 class="modal-title">Duplicate Route</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <p>Create a copy of <strong>{{ route.name }}</strong> for a new date:</p>
              <div class="mb-3">
                <label class="form-label">New Date</label>
                <input type="date" name="new_date" class="form-control" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Duplicate</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </tbody>
</table>
{% else %}
<div class="alert alert-info">
  <h5>No Routes Found</h5>
  {% if filter_date %}
  <p>No routes found for the selected date.</p>
  <a href="/delivery/admin/routes" class="btn btn-outline-secondary me-2">Show All</a>
  {% else %}
  <p>Create your first delivery route to get started.</p>
  {% endif %}
  <a href="/delivery/admin/routes/create" class="btn btn-primary">+ Create Route</a>
</div>
{% endif %}
{% endblock %}
